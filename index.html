<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.R CONTRACT - Overtime Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh; padding: 20px; color: #fff;
        }
        .container {
            max-width: 1100px; margin: 0 auto; background: rgba(255,255,255,0.05);
            border-radius: 20px; padding: 30px; backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .main-heading { text-align: center; font-size: 32px; font-weight: bold; color: #FFD700; margin-bottom: 5px; }
        .sub-heading { text-align: center; font-size: 15px; font-weight: bold; color: #00e5ff; margin-bottom: 25px; }
        .info-section { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .info-group { flex: 1; min-width: 250px; }
        .info-group label { display: block; font-size: 15px; font-weight: bold; color: #FFD700; margin-bottom: 8px; }
        .info-group input {
            width: 100%; padding: 12px; border: 2px solid rgba(255,215,0,0.3);
            border-radius: 10px; background: rgba(255,255,255,0.08); color: #fff; font-weight: bold;
        }
        .table-container { overflow-x: auto; margin-bottom: 20px; border-radius: 12px; border: 1px solid rgba(255,215,0,0.2); }
        table { width: 100%; border-collapse: collapse; }
        thead th { background: linear-gradient(135deg, #FFD700, #FFA000); color: #000; padding: 12px; white-space: nowrap; }
        tbody td { padding: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
        tbody tr { background: rgba(255,255,255,0.03); }
        input { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,215,0,0.2); color: #fff; padding: 5px; border-radius: 4px; text-align: center; }
        .ot-display { color: #00e5ff; font-weight: bold; }
        .rs-display { color: #00ff88; font-weight: bold; }
        .total-row td { color: #FFD700; font-weight: bold; font-size: 16px; border-top: 2px solid #FFD700; padding: 14px; }
        
        /* PDF Date Style */
        .pdf-date-text { font-weight: bold; color: #fff; font-size: 14px; }

        .btn-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 25px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #fff; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-add { background: #00b894; color: #000; }
        .btn-save { background: #2980b9; } 
        .btn-remove { background: #e74c3c; }
        .btn-clear { background: #d35400; }
        .btn-pdf { background: #FFD700; color: #000; font-size: 16px; padding: 14px 40px; }
        .btn-print { background: #fff; color: #000; font-size: 16px; padding: 14px 40px; border: 2px solid #FFD700; }
        
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #fff; border-top: 5px solid #FFD700; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* PRINT MEDIA QUERY (For Backup Button) */
        @media print {
            body { background: #fff; color: #000; }
            .container { box-shadow: none; border: none; background: #fff; color: #000; width: 100%; max-width: 100%; padding: 0; }
            .btn-container, .loading-overlay, .hide-in-pdf, .creator-footer { display: none !important; }
            input { border: none; background: transparent; color: #000; text-align: center; }
            .main-heading, .sub-heading { color: #000; text-shadow: none; }
            thead th { background: #ddd !important; color: #000; border: 1px solid #000; }
            tbody td, .total-row td { color: #000; border: 1px solid #000; }
            .total-row { background: #eee !important; }
            label { color: #000; }
            .info-group input { border: 1px solid #000; color: #000; }
            .ot-display, .rs-display { color: #000; }
            /* Force black text for print */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div style="color:#FFD700; margin-top:10px; font-weight:bold;">PDF àª¬àª¨àª¾àªµà«€ àª°àª¹à«àª¯àª¾ àª›à«€àª...</div>
</div>

<div class="container" id="invoice">
    <h1 class="main-heading">D.R CONTRACT</h1>
    <div class="sub-heading">BLENDING</div>
    <hr style="border-color: #FFD700; margin: 20px 0;">

    <div class="info-section">
        <div class="info-group">
            <label>NAME (àª¨àª¾àª®)</label>
            <input type="text" id="workerName" placeholder="àª¨àª¾àª® àª²àª–à«‹...">
        </div>
        <div class="info-group">
            <label>àª¹àª¾àªœàª°à«€ àª¨àª‚àª¬àª° (ATTENDANCE NO.)</label>
            <input type="text" id="hajariNo" placeholder="àª¹àª¾àªœàª°à«€ àª¨àª‚àª¬àª° àª²àª–à«‹...">
        </div>
    </div>

    <div class="table-container">
        <table id="otTable">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>àª¤àª¾àª°à«€àª–</th>
                    <th>START TIME</th>
                    <th>END TIME</th>
                    <th>TOTAL OT</th>
                    <th>RATE (â‚¹)</th>
                    <th>TOTAL (â‚¹)</th>
                    <th>REMARKS</th>
                    <th class="hide-in-pdf">DEL</th>
                </tr>
            </thead>
            <tbody id="otBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="4" style="text-align:right;">GRAND TOTAL :</td>
                    <td id="grandTotalOT">0.00</td>
                    <td>-</td>
                    <td id="grandTotalRS">0.00</td>
                    <td colspan="2">-</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="btn-container data-buttons">
        <button class="btn btn-add" onclick="addNewRow()">+ ROW àª‰àª®à«‡àª°à«‹</button>
        <button class="btn btn-save" onclick="saveData()">ğŸ’¾ àª¡à«‡àªŸàª¾ àª¸à«‡àªµ àª•àª°à«‹</button>
        <button class="btn btn-remove" onclick="removeLastRow()">- àª›à«‡àª²à«àª²à«€ ROW àª•àª¾àª¢à«‹</button>
        <button class="btn btn-clear" onclick="clearAll()">àª¬àª§à«àª‚ àª¸àª¾àª« àª•àª°à«‹</button>
    </div>

    <div class="btn-container pdf-button-container">
        <button class="btn btn-pdf" onclick="generatePDF()">SAVE AS PDF (àª¡àª¿àªàª¾àª‡àª¨ àª¸àª¾àª¥à«‡)</button>
        <button class="btn btn-print" onclick="window.print()">PRINT / PDF (àª¸àª°àª³ àª°à«€àª¤)</button>
    </div>
    
    <div style="text-align:center; margin-top:20px; color:#FFD700; font-size:12px;">
        àªœà«‹ àªªàª¹à«‡àª²à«àª‚ àª¬àªŸàª¨ àª•àª¾àª® àª¨ àª•àª°à«‡, àª¤à«‹ "PRINT / PDF (àª¸àª°àª³ àª°à«€àª¤)" àª¬àªŸàª¨ àª¦àª¬àª¾àªµà«‹.
    </div>
</div>

<script>
    window.onload = function() { loadData(); };

    function addNewRow(data = null) {
        const tbody = document.getElementById('otBody');
        const tr = document.createElement('tr');
        const index = tbody.rows.length + 1;

        const dateVal = data ? data.date : '';
        const startVal = data ? data.start : '';
        const endVal = data ? data.end : '';
        const rateVal = data ? data.rate : '';
        const remarkVal = data ? data.remark : '';

        tr.innerHTML = `
            <td class="sr-no">${index}</td>
            <td><input type="date" class="date-input" value="${dateVal}"></td>
            <td><input type="time" class="time-input" value="${startVal}" onchange="calcRow(this)"></td>
            <td><input type="time" class="time-input" value="${endVal}" onchange="calcRow(this)"></td>
            <td class="ot-display">0.00</td>
            <td><input type="number" class="num-input" placeholder="0" value="${rateVal}" oninput="calcRow(this)"></td>
            <td class="rs-display">0.00</td>
            <td><input type="text" class="text-input" value="${remarkVal}" placeholder="àª¨à«‹àª‚àª§..."></td>
            <td class="hide-in-pdf"><button style="background:red; color:white; border:none; border-radius:4px; cursor:pointer;" onclick="deleteRow(this)">X</button></td>
        `;
        tbody.appendChild(tr);

        if (data) { calcRow(tr.querySelector('.time-input')); }
    }

    function calcRow(element) {
        if(!element) return;
        const row = element.closest('tr');
        const start = row.querySelectorAll('.time-input')[0].value;
        const end = row.querySelectorAll('.time-input')[1].value;
        const rate = parseFloat(row.querySelector('.num-input').value) || 0;
        
        let hours = 0;
        if (start && end) {
            let s = new Date(`2000-01-01T${start}`);
            let e = new Date(`2000-01-01T${end}`);
            if (e < s) e.setDate(e.getDate() + 1);
            hours = (e - s) / 1000 / 60 / 60;
        }

        row.querySelector('.ot-display').innerText = hours.toFixed(2);
        row.querySelector('.rs-display').innerText = (hours * rate).toFixed(2);
        calcGrandTotal();
    }

    function calcGrandTotal() {
        let totalOT = 0;
        let totalRS = 0;
        document.querySelectorAll('#otBody tr').forEach(row => {
            totalOT += parseFloat(row.querySelector('.ot-display').innerText) || 0;
            totalRS += parseFloat(row.querySelector('.rs-display').innerText) || 0;
        });
        document.getElementById('grandTotalOT').innerText = totalOT.toFixed(2);
        document.getElementById('grandTotalRS').innerText = totalRS.toFixed(2);
    }

    function removeLastRow() {
        const tbody = document.getElementById('otBody');
        if(tbody.rows.length > 0) { tbody.deleteRow(tbody.rows.length - 1); calcGrandTotal(); }
    }
    function deleteRow(btn) { btn.closest('tr').remove(); resetSrNo(); calcGrandTotal(); }
    function resetSrNo() { document.querySelectorAll('#otBody tr').forEach((row, index) => { row.querySelector('.sr-no').innerText = index + 1; }); }

    function saveData() {
        const rows = [];
        document.querySelectorAll('#otBody tr').forEach(row => {
            rows.push({
                date: row.querySelector('.date-input').value,
                start: row.querySelectorAll('.time-input')[0].value,
                end: row.querySelectorAll('.time-input')[1].value,
                rate: row.querySelector('.num-input').value,
                remark: row.querySelector('.text-input').value
            });
        });
        const data = {
            workerName: document.getElementById('workerName').value,
            hajariNo: document.getElementById('hajariNo').value,
            rows: rows
        };
        localStorage.setItem('otData', JSON.stringify(data));
        alert('àª¡à«‡àªŸàª¾ àª¸àª«àª³àª¤àª¾àªªà«‚àª°à«àªµàª• àª¸à«‡àªµ àª¥àª¯à«‹ àª›à«‡!');
    }

    function loadData() {
        const savedData = localStorage.getItem('otData');
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById('workerName').value = data.workerName || '';
            document.getElementById('hajariNo').value = data.hajariNo || '';
            document.getElementById('otBody').innerHTML = '';
            if(data.rows && data.rows.length > 0) { data.rows.forEach(rowData => addNewRow(rowData)); }
        }
    }

    function clearAll() {
        if(confirm('àª¬àª§à«‹ àª¡à«‡àªŸàª¾ àª¸àª¾àª« àª•àª°àªµà«‹ àª›à«‡?')) {
            document.getElementById('otBody').innerHTML = '';
            document.getElementById('workerName').value = '';
            document.getElementById('hajariNo').value = '';
            document.getElementById('grandTotalOT').innerText = '0.00';
            document.getElementById('grandTotalRS').innerText = '0.00';
            localStorage.removeItem('otData');
        }
    }

    function generatePDF() {
        const loading = document.getElementById('loadingOverlay');
        loading.style.display = 'flex';
        
        try {
            document.querySelector('.data-buttons').style.display = 'none';
            document.querySelector('.pdf-button-container').style.display = 'none';
            document.querySelectorAll('.hide-in-pdf').forEach(el => el.style.display = 'none');

            // Date Change Logic
            const dateInputs = document.querySelectorAll('.date-input');
            dateInputs.forEach(input => {
                input.setAttribute('value', input.value);
                if(input.value) {
                    const parts = input.value.split('-');
                    if(parts.length === 3) {
                        const indianDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        const span = document.createElement('span');
                        span.className = 'pdf-date-text';
                        span.innerText = indianDate;
                        input.style.display = 'none';
                        input.parentNode.appendChild(span);
                    }
                }
            });
            
            document.querySelectorAll('input:not(.date-input)').forEach(input => input.setAttribute('value', input.value));

            const element = document.querySelector('.container');
            const name = document.getElementById('workerName').value || 'Report';
            
            const opt = {
                margin: 0.2, filename: `${name}_OT.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save()
            .then(() => {
                resetView();
                loading.style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                alert("PDF àª¬àª¨àª¾àªµàªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€ àª›à«‡. àª•à«ƒàªªàª¾ àª•àª°à«€ 'PRINT / PDF (àª¸àª°àª³ àª°à«€àª¤)' àª¬àªŸàª¨ àªµàª¾àªªàª°à«‹.");
                resetView();
                loading.style.display = 'none';
            });

        } catch (e) {
            alert("àª­à«‚àª² àª†àªµà«€ àª›à«‡. 'PRINT / PDF (àª¸àª°àª³ àª°à«€àª¤)' àª¬àªŸàª¨ àªµàª¾àªªàª°à«‹.");
            resetView();
            loading.style.display = 'none';
        }
    }

    function resetView() {
        document.querySelector('.data-buttons').style.display = 'flex';
        document.querySelector('.pdf-button-container').style.display = 'flex';
        document.querySelectorAll('.hide-in-pdf').forEach(el => el.style.display = 'table-cell');
        document.querySelectorAll('.pdf-date-text').forEach(span => span.remove());
        document.querySelectorAll('.date-input').forEach(input => input.style.display = 'inline-block');
    }
</script>

</body>
</html>
